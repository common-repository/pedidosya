'use strict';

jQuery(document).ready(function(){
  (function($, settings){

    function showSpinner(){
      var htmlString = "<div class='"+settings.spinner_id+"'><div class='"+settings.spinner_id+"-center'><span class='spinner is-active'></span></div></div>";
      htmlString = htmlString + "<style> ."+settings.spinner_id+"{z-index:99999;width: 100%;height: 100%;position: fixed;top: 0;left: 0;opacity: 0.4;background-color:#ccc;text-align: center; } ."+settings.spinner_id+"-center{position: absolute;top: 50%; left: 50%; transform: translate(-50%, -50%); } ."+settings.spinner_id+" .spinner{ vertical-align: middle; }</style>";
      $("body").prepend(htmlString);
    }

    function cleanError(){
      if ($('#' + settings.error_id).length > 0) {
          $('#' + settings.error_id).remove();
      }
    }

    function addError(order_id){
      cleanError();
      $(".wrap",$('#wpbody-content')).prepend( settings.error_notification.replace("%1", order_id) );
    }

    $('.peya-action').click(function (e){
        var attrActionId = $(this).attr('data-action');
        var attrOrderId = $(this).attr('data-id');
        var attrReason = "";
        var doAction = true;
        if (attrActionId == "peya_action_cancel" ) {
          var txt;
          attrReason = prompt(settings.cancel_reason_text, settings.cancel_reason_default);
          if (attrReason == null || attrReason == "") {
            doAction = false;
          } else {
            doAction = true;
          }
        }
        if(doAction){
          var dataToSend = {
            action: attrActionId,
            action_reason: attrReason,
            order_id: attrOrderId,
            nonce: settings.ajax_nonce
          }
          //var UniqueId = Math.floor(Math.random() * 26) + Date.now();
          //$(this).append("<img id='"+settings.spinner_id+UniqueId+"' src='"+settings.spinner_url+ "' />");
          showSpinner();
          //jQuery("."+ settings.spinner_id ).toggle();
          //jQuery("."+ settings.spinner_id).find(".spinner").addClass("is-active");

          cleanError();
          $.post(settings.ajax_url, dataToSend, function (data) {
              if (data.success) {
                  if (attrActionId == "peya_action_proof_of_delivery" ) {
                    var a = document.createElement("a"); //Create <a>
                    a.href = "data:image/jpg;base64," + data.data.image; //Image Base64 Goes here
                    a.download = "proof_of_delivery.jpg"; //File name Here
                    a.click(); //Downloaded file
                    //$("#" + settings.spinner_id+UniqueId).remove();
                  } else {
                    //$("#" + settings.spinner_id+UniqueId).remove();
                    location.reload();
                  }
              } else {
              //$("#" + settings.spinner_id+UniqueId).remove();
              addError(attrOrderId);
              }
              jQuery("."+ settings.spinner_id ).remove();
          });
        }
    })
  })(jQuery, wc_peya_settings);

});
